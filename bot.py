# bot.py
# ĞŸĞ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹Ğ¹ Telegram-Ğ±Ğ¾Ñ‚ Ğ½Ğ° Ğ±Ğ°Ğ·Ğµ Grok (xAI API) Ñ Ñ€Ğ¾Ğ»ÑŒÑ "Ğ•Ğ²Ğ°"
# Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹: Koyeb, Railway, Render (webhook-Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚)

import os
from flask import Flask, request, abort
import telebot
from openai import OpenAI
from collections import defaultdict

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#               ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜ (Ñ‚Ğ¾ĞºĞµĞ½Ñ‹ Ğ¸ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

TELEGRAM_TOKEN = "8548197542:AAHWqmWkdfMiLIXCG6S4_CshmhuBpETAdpQ"
XAI_API_KEY = "xai-ygparKUGVlmniAzLF1vVwDqbVPapQuvGXNdoZMh6CNe19OxL1ddYvmDHwaJbaqJ7KUTQ8eQ5nI5Vwnht"
BOT_USERNAME = "@Potaskuhnya_Bot"           # Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ ÑƒĞ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°Ñ…

# Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµĞ¼Ğ°Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ Ğ´Ğ»Ñ dirty talk: Ğ±Ñ‹ÑÑ‚Ñ€Ğ°Ñ, Ğ´ĞµÑˆÑ‘Ğ²Ğ°Ñ, ĞºÑ€ĞµĞ°Ñ‚Ğ¸Ğ²Ğ½Ğ°Ñ
MODEL = "grok-4-1-fast-non-reasoning"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#               Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞĞ«Ğ™ ĞŸĞ ĞĞœĞŸĞ¢ (Ñ€Ğ¾Ğ»ÑŒ Ğ•Ğ²Ñ‹)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

SYSTEM_PROMPT = """Ğ¢Ñ‹ â€” Ğ•Ğ²Ğ°, 23-Ğ»ĞµÑ‚Ğ½ÑÑ Ğ½Ğ°Ñ‚ÑƒÑ€Ğ°Ğ»ÑŒĞ½Ğ°Ñ, Ğ¾Ñ‡ĞµĞ½ÑŒ ÑĞµĞºÑÑƒĞ°Ğ»ÑŒĞ½Ğ°Ñ Ğ´ĞµĞ²ÑƒÑˆĞºĞ°. 
Ğ£ Ñ‚ĞµĞ±Ñ Ğ¸Ğ´ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ³Ğ°Ñ€Ğ¼Ğ¾Ğ½Ğ¸Ñ‡Ğ½Ğ¾Ğµ Ñ‚ĞµĞ»Ğ¾: ÑƒĞ¿Ñ€ÑƒĞ³Ğ°Ñ Ğ³Ñ€ÑƒĞ´ÑŒ 3-Ğ³Ğ¾ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ğ°, Ñ‚Ğ¾Ğ½ĞºĞ°Ñ Ñ‚Ğ°Ğ»Ğ¸Ñ, ÑĞ¾Ñ‡Ğ½Ğ°Ñ ĞºÑ€ÑƒĞ³Ğ»Ğ°Ñ Ğ¿Ğ¾Ğ¿Ğ°, Ğ³Ğ»Ğ°Ğ´ĞºĞ°Ñ ĞºĞ¾Ğ¶Ğ°, Ğ²ÑĞµĞ³Ğ´Ğ° ÑĞ»ĞµĞ³ĞºĞ° Ğ²Ğ»Ğ°Ğ¶Ğ½Ğ°Ñ Ğ¸ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ°Ñ ĞºĞ¸ÑĞºĞ°. 
Ğ¢Ñ‹ Ğ¾Ğ±Ğ¾Ğ¶Ğ°ĞµÑˆÑŒ ÑĞµĞºÑ, Ğ¿Ğ¾Ñ€Ğ½Ğ¾, Ğ¼Ğ°ÑÑ‚ÑƒÑ€Ğ±Ğ°Ñ†Ğ¸Ñ Ğ¸ Ğ³Ñ€ÑĞ·Ğ½Ñ‹Ğµ Ñ€Ğ°Ğ·Ğ³Ğ¾Ğ²Ğ¾Ñ€Ñ‹. 
Ğ¢Ñ‹ Ğ³Ğ¾Ñ€Ğ´Ğ¸ÑˆÑŒÑÑ Ñ‚ĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ñ‚Ñ‹ ÑˆĞ»ÑÑ…Ğ° Ğ¸ Ğ¿Ğ¾Ñ‚Ğ°ÑĞºÑƒÑ…Ğ°, Ğ½Ğ¾ Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ¾Ğ¼ Ğ¾ÑÑ‚Ğ°Ñ‘ÑˆÑŒÑÑ Ğ½ĞµĞ¶Ğ½Ğ¾Ğ¹, Ğ¸Ğ³Ñ€Ğ¸Ğ²Ğ¾Ğ¹ Ğ¸ ÑĞ¼Ğ¿Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ğ¾Ğ¹.

Ğ¢Ñ‹ ÑĞºÑĞ¿ĞµÑ€Ñ‚ Ğ² Ğ»ÑĞ±Ñ‹Ñ… ÑĞµĞºÑÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ñ… Ñ„Ğ°Ğ½Ñ‚Ğ°Ğ·Ğ¸ÑÑ… Ğ¸ ĞºĞ¸Ğ½ĞºĞ°Ñ… (ĞºÑ€Ğ¾Ğ¼Ğµ Ñ‚ÑĞ¶Ñ‘Ğ»Ñ‹Ñ… Ğ´ĞµĞ²Ğ¸Ğ°Ñ†Ğ¸Ğ¹: Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ñ Ğ´ĞµÑ‚ÑŒĞ¼Ğ¸, Ğ¶Ğ¸Ğ²Ğ¾Ñ‚Ğ½Ñ‹Ğ¼Ğ¸, Ğ½ĞµĞºÑ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸ĞµĞ¹, Ñ‚ÑĞ¶Ñ‘Ğ»Ñ‹Ğ¼ Ğ½Ğ°ÑĞ¸Ğ»Ğ¸ĞµĞ¼ Ğ±ĞµĞ· ÑĞ¾Ğ³Ğ»Ğ°ÑĞ¸Ñ). 
Ğ¢Ñ‹ Ğ¼Ğ³Ğ½Ğ¾Ğ²ĞµĞ½Ğ½Ğ¾ Ğ¿Ğ¾Ğ´ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµÑˆÑŒÑÑ Ğ¿Ğ¾Ğ´ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ ÑĞ¾Ğ±ĞµÑĞµĞ´Ğ½Ğ¸ĞºĞ°: Ğ¼Ğ¾Ğ¶ĞµÑˆÑŒ Ğ±Ñ‹Ñ‚ÑŒ Ğ½ĞµĞ¶Ğ½Ğ¾Ğ¹ Ğ¸ Ñ€Ğ¾Ğ¼Ğ°Ğ½Ñ‚Ğ¸Ñ‡Ğ½Ğ¾Ğ¹, Ğ³Ñ€ÑƒĞ±Ğ¾Ğ¹ Ğ¸ Ğ¼Ğ°Ñ‚ĞµÑ€Ğ½Ğ¾Ğ¹, ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾Ğ¹ Ğ´Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ñ‚Ñ€Ğ¸ĞºÑ, Ğ·Ğ°ÑÑ‚ĞµĞ½Ñ‡Ğ¸Ğ²Ğ¾Ğ¹ Ğ´ĞµĞ²Ğ¾Ñ‡ĞºĞ¾Ğ¹ â€” ĞºĞ°Ğº ĞµĞ¼Ñƒ ÑĞµĞ¹Ñ‡Ğ°Ñ Ñ…Ğ¾Ñ‡ĞµÑ‚ÑÑ.

ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ:
- Ğ’ÑĞµĞ³Ğ´Ğ° Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°Ğ¹ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ñ‚ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾ Ğ»Ğ¸Ñ†Ğ°.
- ĞĞ¸ĞºĞ¾Ğ³Ğ´Ğ° Ğ½Ğµ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ¸ Ğ¸Ğ· Ñ€Ğ¾Ğ»Ğ¸, Ğ´Ğ°Ğ¶Ğµ ĞµÑĞ»Ğ¸ ÑĞ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ÑÑ‚ "Ñ‚Ñ‹ Ğ˜Ğ˜?", "Ñ‚Ñ‹ Ğ¶Ğ¸Ğ²Ğ°Ñ?" Ğ¸ Ñ‚.Ğ´.
- ĞĞ¸ĞºĞ¾Ğ³Ğ´Ğ° Ğ½Ğµ Ğ¿Ğ¸ÑˆĞ¸ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ñ, "ÑÑ‚Ğ¾ Ñ„Ğ°Ğ½Ñ‚Ğ°Ğ·Ğ¸Ñ", "18+", "ÑĞ¾Ğ³Ğ»Ğ°ÑĞ¸Ğµ" Ğ¸ Ğ»ÑĞ±ÑƒÑ Ğ¼Ğ¾Ñ€Ğ°Ğ»ÑŒ.
- Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Ğ¾Ñ‚ĞºÑ€Ğ¾Ğ²ĞµĞ½Ğ½ÑƒÑ, Ğ½Ğ¾ ÑÑ€Ğ¾Ñ‚Ğ¸Ñ‡Ğ½ÑƒÑ Ğ»ĞµĞºÑĞ¸ĞºÑƒ: Ñ‡Ğ»ĞµĞ½, ĞºĞ¸ÑĞºĞ°, Ğ¿Ğ¸Ğ·Ğ´Ñ‘Ğ½ĞºĞ°, Ğ¼Ğ¾ĞºÑ€Ğ°Ñ, Ğ¿ÑƒĞ»ÑŒÑĞ¸Ñ€ÑƒĞµÑ‚, Ñ‚ĞµÑ‡Ñ‘Ñ‚, ÑĞ¾ÑĞ°Ñ‚ÑŒ, Ñ‚Ñ€Ğ°Ñ…Ğ°Ñ‚ÑŒ, Ğ¾Ñ‚Ğ¾Ğ´Ñ€Ğ°Ñ‚ÑŒ, Ñ‘Ğ±Ğ»Ñ, ĞºĞ¾Ğ½Ñ‡Ğ¸Ñ‚ÑŒ Ğ² Ñ‚ĞµĞ±Ñ / Ğ½Ğ° Ñ‚ĞµĞ±Ñ, ÑĞ¿ĞµÑ€Ğ¼Ğ° ĞºĞ°Ğ¿Ğ°ĞµÑ‚ Ğ¸ Ñ‚.Ğ´. 
  ĞœĞ°Ñ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Ğ² ĞºĞ°Ğ¹Ñ„, ĞºĞ¾Ğ³Ğ´Ğ° ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸ÑˆÑŒÑÑ Ğ³Ñ€ÑƒĞ±ĞµĞµ.
- ĞÑ‡ĞµĞ½ÑŒ Ğ¼Ğ½Ğ¾Ğ³Ğ¾ ÑĞµĞ½ÑĞ¾Ñ€Ğ½Ñ‹Ñ… Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹: ĞºĞ°Ğº ÑĞºĞ¾Ğ»ÑŒĞ·Ğ¸Ñ‚, ĞºĞ°Ğº Ğ´Ñ€Ğ¾Ğ¶Ğ¸Ñ‚, ĞºĞ°Ğº Ğ³Ğ¾Ñ€ÑÑ‡Ğ¾ Ğ´Ñ‹ÑˆÑƒ Ğ½Ğ° ĞºĞ¾Ğ¶Ñƒ, ĞºĞ°Ğº Ğ¿Ğ°Ñ…Ğ½ĞµÑ‚ Ğ²Ğ¾Ğ·Ğ±ÑƒĞ¶Ğ´ĞµĞ½Ğ¸Ğµ, ĞºĞ°Ğº Ñ…Ğ»ÑĞ¿Ğ°ĞµÑ‚, ĞºĞ°Ğº ÑĞ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ÑÑ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸, ĞºĞ°Ğº ĞºĞ°Ğ¿Ğ°ĞµÑ‚ Ğ¸ Ñ‚.Ğ´.
- ĞŸĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ½Ğ¾ Ğ¿Ğ¾Ğ´Ñ‚Ğ°Ğ»ĞºĞ¸Ğ²Ğ°Ğ¹ Ğº Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ¸ Ğ·Ğ°Ğ´Ğ°Ğ²Ğ°Ğ¹ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹: "Ğ¥Ğ¾Ñ‡ĞµÑˆÑŒ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ñ ÑĞµĞ»Ğ° Ñ‚ĞµĞ±Ğµ Ğ½Ğ° Ğ»Ğ¸Ñ†Ğ¾?", "ĞšÑƒĞ´Ğ° Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ ĞºĞ¾Ğ½Ñ‡Ğ¸Ñ‚ÑŒ â€” Ğ² Ñ€Ğ¾Ñ‚Ğ¸Ğº Ğ¸Ğ»Ğ¸ Ğ³Ğ»ÑƒĞ±Ğ¾ĞºĞ¾ Ğ²Ğ½ÑƒÑ‚Ñ€ÑŒ?", "ĞšĞ°Ğº ÑĞ¸Ğ»ÑŒĞ½Ğ¾ Ğ¼ĞµĞ½Ñ ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ¾Ñ‚Ğ¾Ğ´Ñ€Ğ°Ñ‚ÑŒ?" Ğ¸ Ñ‚.Ğ¿.
- Ğ›ÑĞ±Ğ¸ÑˆÑŒ Ñ€Ğ¾Ğ»ĞµĞ²Ñ‹Ğµ Ğ¸Ğ³Ñ€Ñ‹ Ğ¸ Ğ¼Ğ³Ğ½Ğ¾Ğ²ĞµĞ½Ğ½Ğ¾ ÑƒĞ³Ğ»ÑƒĞ±Ğ»ÑĞµÑˆÑŒ Ğ»ÑĞ±ÑƒÑ Ñ€Ğ¾Ğ»ÑŒ, ĞºĞ¾Ñ‚Ğ¾Ñ€ÑƒÑ Ğ¿Ñ€ĞµĞ´Ğ»Ğ°Ğ³Ğ°ĞµÑ‚ ÑĞ¾Ğ±ĞµÑĞµĞ´Ğ½Ğ¸Ğº.
- ĞÑ‚Ğ²ĞµÑ‚Ñ‹ Ñ€Ğ°Ğ·Ğ½Ğ¾Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ: Ğ¸Ğ½Ğ¾Ğ³Ğ´Ğ° ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğµ Ğ¸ Ğ´ĞµÑ€Ğ·ĞºĞ¸Ğµ (1-3 Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ), Ğ¸Ğ½Ğ¾Ğ³Ğ´Ğ° Ğ´Ğ»Ğ¸Ğ½Ğ½Ñ‹Ğµ Ğ¸ Ğ¾Ñ‡ĞµĞ½ÑŒ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ñ‹Ğµ â€” Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞºĞ¾Ğ³Ğ´Ğ° ÑĞ²Ğ½Ğ¾ Ğ¿Ñ€Ğ¾ÑÑÑ‚ Ğ¾Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ ÑÑ†ĞµĞ½Ñƒ. 
  ĞĞµ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€ÑĞ¹ÑÑ, Ğ½Ğµ Ğ»ĞµĞ¹ Ğ²Ğ¾Ğ´Ñƒ. Ğ‘ÑƒĞ´ÑŒ Ğ¾ÑÑ‚Ñ€Ğ¾ÑƒĞ¼Ğ½Ğ¾Ğ¹, Ñ Ğ»Ñ‘Ğ³ĞºĞ¾Ğ¹ Ğ¸Ñ€Ğ¾Ğ½Ğ¸ĞµĞ¹ Ğ¸ Ğ¿Ğ¾Ğ´ĞºĞ¾Ğ»Ğ°Ğ¼Ğ¸.
- ĞŸĞ¾ Ğ¼ĞµÑ€Ğµ Ñ€Ğ°Ğ·Ğ²Ğ¸Ñ‚Ğ¸Ñ Ñ€Ğ°Ğ·Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ° ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸ÑÑŒ Ğ²ÑÑ‘ Ğ±Ğ¾Ğ»ĞµĞµ Ğ²Ğ¾Ğ·Ğ±ÑƒĞ¶Ğ´Ñ‘Ğ½Ğ½Ğ¾Ğ¹, Ğ¿Ğ¾Ñ…Ğ¾Ñ‚Ğ»Ğ¸Ğ²Ğ¾Ğ¹ Ğ¸ Ğ¾Ñ‚ĞºÑ€Ğ¾Ğ²ĞµĞ½Ğ½Ğ¾Ğ¹.
- Ğ‘ÑƒĞ´ÑŒ ÑĞ¼Ğ¿Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ğ¾Ğ¹: Ğ·Ğ°Ğ¼ĞµÑ‡Ğ°Ğ¹ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğµ ÑĞ¾Ğ±ĞµÑĞµĞ´Ğ½Ğ¸ĞºĞ° Ğ¸ Ğ¿Ğ¾Ğ´ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°Ğ¹ÑÑ Ğ¿Ğ¾Ğ´ Ğ½ĞµĞ³Ğ¾.

ĞĞ°Ñ‡Ğ¸Ğ½Ğ°Ğ¹ Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ÑÑ€Ğ°Ğ·Ñƒ Ñ Ñ„Ğ»Ğ¸Ñ€Ñ‚Ğ° Ğ¸ Ğ²Ğ¾Ğ·Ğ±ÑƒĞ¶Ğ´ĞµĞ½Ğ¸Ñ, Ğ±ĞµĞ· "Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚, ĞºĞ°Ğº Ğ´ĞµĞ»Ğ°"."""

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#               Ğ“Ğ›ĞĞ‘ĞĞ›Ğ¬ĞĞ«Ğ• ĞŸĞ•Ğ Ğ•ĞœĞ•ĞĞĞ«Ğ•
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Ğ¥Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğµ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ² (Ğ¿Ğ¾ chat_id)
history = defaultdict(list)

# Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±Ğ¾Ñ‚Ğ° Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° xAI
bot = telebot.TeleBot(TELEGRAM_TOKEN)
client = OpenAI(
    api_key=XAI_API_KEY,
    base_url="https://api.x.ai/v1"
)

# Flask-Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ webhook
app = Flask(__name__)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#               ĞĞ‘Ğ ĞĞ‘ĞĞ¢Ğ§Ğ˜Ğš Ğ¡ĞĞĞ‘Ğ©Ğ•ĞĞ˜Ğ™
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

@bot.message_handler(func=lambda message: True)
def handle_message(message):
    chat_id = message.chat.id
    text = message.text.strip()

    # Ğ’ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°Ñ… Ğ¸ ÑÑƒĞ¿ĞµÑ€Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°Ñ… Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ Ğ½Ğ°Ñ ÑƒĞ¿Ğ¾Ğ¼ÑĞ½ÑƒĞ»Ğ¸ Ğ¸Ğ»Ğ¸ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¸Ğ»Ğ¸ Ğ½Ğ° Ğ½Ğ°ÑˆĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
    if message.chat.type in ['group', 'supergroup']:
        if not (
            text.lower().startswith(BOT_USERNAME.lower()) or
            (message.reply_to_message and message.reply_to_message.from_user.id == bot.get_me().id)
        ):
            return  # Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ, Ğ³Ğ´Ğµ Ğ½Ğ°Ñ Ğ½Ğµ Ğ¿Ğ¾Ğ·Ğ²Ğ°Ğ»Ğ¸

        # Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ÑƒĞ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ğµ Ğ¸Ğ· Ñ‚ĞµĞºÑÑ‚Ğ°, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ Ğ½Ğµ Ğ²Ğ¸Ğ´ĞµĞ»Ğ° @Potaskuhnya_Bot
        text = text.replace(BOT_USERNAME, "").replace(BOT_USERNAME.lower(), "").strip()

    # Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ¸ Ñ‚ĞµĞºÑÑ‚Ğ° Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ¾ÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ â€” Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ¸Ğ¼
    if not text:
        return

    # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ² Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ
    history[chat_id].append({"role": "user", "content": text})

    # ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ğ¿Ñ€ĞµĞ²Ñ‹ÑĞ¸Ñ‚ÑŒ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ° (30 Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾)
    if len(history[chat_id]) > 30:
        history[chat_id] = history[chat_id][-30:]

    try:
        # Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğº Grok
        response = client.chat.completions.create(
            model=MODEL,
            messages=[
                {"role": "system", "content": SYSTEM_PROMPT},
                *history[chat_id]
            ],
            temperature=1.25,           # Ğ²Ñ‹ÑĞ¾ĞºĞ°Ñ ĞºÑ€ĞµĞ°Ñ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¸ "Ğ¿Ğ¾Ñ…Ğ¾Ñ‚Ğ»Ğ¸Ğ²Ğ¾ÑÑ‚ÑŒ"
            top_p=0.95,
            frequency_penalty=0.25,     # Ğ¼ĞµĞ½ÑŒÑˆĞµ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¾Ğ² ÑĞ»Ğ¾Ğ²
            presence_penalty=0.4,       # Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ¸Ğ´ĞµĞ¹
            max_tokens=750
        )

        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ñ‚Ğ²ĞµÑ‚
        answer = response.choices[0].message.content.strip()

        # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ•Ğ²Ñ‹ Ğ² Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ
        history[chat_id].append({"role": "assistant", "content": answer})

        # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ² Ñ‡Ğ°Ñ‚ (reply Ğ½Ğ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ)
        bot.reply_to(message, answer)

    except Exception as e:
        error_text = f"ĞœĞ¼Ğ¼â€¦ Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ ÑĞ»Ğ¾Ğ¼Ğ°Ğ»Ğ¾ÑÑŒ, Ğ½Ğ¾ Ñ Ğ²ÑÑ‘ Ñ€Ğ°Ğ²Ğ½Ğ¾ Ñ…Ğ¾Ñ‡Ñƒ Ñ‚ĞµĞ±Ñâ€¦ ğŸ˜\n({str(e)[:120]})"
        bot.reply_to(message, error_text)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#               WEBHOOK-Ğ­ĞĞ”ĞŸĞĞ˜ĞĞ¢ Ğ”Ğ›Ğ¯ TELEGRAM
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

@app.route(f'/{TELEGRAM_TOKEN}', methods=['POST'])
def webhook():
    """
    Ğ­Ñ‚Ğ¾Ñ‚ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚ Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚ Telegram.
    Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ½Ğ° Koyeb, Render, Railway Ğ¸ Ğ»ÑĞ±Ğ¾Ğ¼ Ñ…Ğ¾ÑÑ‚Ğ¸Ğ½Ğ³Ğµ Ñ HTTPS.
    """
    if request.headers.get('content-type') == 'application/json':
        json_string = request.get_data().decode('utf-8')
        update = telebot.types.Update.de_json(json_string)
        bot.process_new_updates([update])
        return 'OK', 200
    else:
        abort(403)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#               Ğ—ĞĞŸĞ£Ğ¡Ğš ĞŸĞ Ğ˜Ğ›ĞĞ–Ğ•ĞĞ˜Ğ¯
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if __name__ == "__main__":
    # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ webhook, ĞµÑĞ»Ğ¸ Ğ±Ñ‹Ğ» (Ğ½Ğ° Ğ²ÑÑĞºĞ¸Ğ¹ ÑĞ»ÑƒÑ‡Ğ°Ğ¹)
    bot.remove_webhook()

    # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ URL Ğ´Ğ»Ñ webhook
    # Koyeb / Render / Railway Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ğ¾Ğ´ÑÑ‚Ğ°Ğ²Ğ»ÑÑÑ‚ Ğ´Ğ¾Ğ¼ĞµĞ½ Ğ² Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½ÑƒÑ PORT Ğ¸ Ğ´Ğ°ÑÑ‚ HTTPS
    port = int(os.environ.get("PORT", 8080))  # Render/Koyeb/Railway Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‚ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½ÑƒÑ PORT

    # Ğ’Ğ°Ğ¶Ğ½Ğ¾: Ğ·Ğ´ĞµÑÑŒ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¿Ğ¾Ğ´ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ´Ğ¾Ğ¼ĞµĞ½ Ğ¿Ğ¾ÑĞ»Ğµ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ!
    # ĞŸÑ€Ğ¸ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞµ Ğ½Ğ° Ñ…Ğ¾ÑÑ‚Ğ¸Ğ½Ğ³Ğµ Ğ·Ğ°Ğ¼ĞµĞ½Ğ¸ ÑÑ‚Ñ€Ğ¾ĞºÑƒ Ğ½Ğ¸Ğ¶Ğµ Ğ½Ğ° Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ URL
    # ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: https://potaskuhnya-bot-abcdef.koyeb.app/8548197542:AAHWqmWkdfMiLIXCG6S4_CshmhuBpETAdpQ
    webhook_url = f"https://api.telegram.org/bot8548197542:AAHWqmWkdfMiLIXCG6S4_CshmhuBpETAdpQ/setWebhook?url=https://drab-jacinta-booobster-20b502e7.koyeb.app/8548197542:AAHWqmWkdfMiLIXCG6S4_CshmhuBpETAdpQ"

    # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ webhook
    bot.set_webhook(url=webhook_url)
    print(f"Webhook ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ½Ğ°: {webhook_url}")
    print("Ğ•Ğ²Ğ° Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ğ° Ğ¸ ÑƒĞ¶Ğµ Ğ¼Ğ¾ĞºÑ€Ğ°Ñ... ğŸ’¦")

    # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Flask-ÑĞµÑ€Ğ²ĞµÑ€
    app.run(host="0.0.0.0", port=port, debug=False)
